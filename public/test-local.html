<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LOCAL Widget Test - NY English Teacher</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      min-height: 100vh;
      margin: 0;
      padding: 40px 20px;
      color: white;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .badge {
      display: inline-block;
      background: #22c55e;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 12px;
      vertical-align: middle;
    }
    p {
      color: #94a3b8;
      line-height: 1.6;
    }
    .card {
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 24px;
      margin: 24px 0;
    }
    .checklist li {
      padding: 8px 0;
      color: #cbd5e1;
    }
    a {
      color: #60a5fa;
    }
    .warning {
      background: rgba(234, 179, 8, 0.2);
      border: 1px solid rgba(234, 179, 8, 0.5);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
    }
    .warning strong {
      color: #fbbf24;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Chat Widget Test <span class="badge">LOCAL</span></h1>

    <div class="warning">
      <strong>Local Development Mode</strong><br>
      This page loads the widget from <code>localhost:3000</code>. Make sure <code>pnpm dev</code> is running.
    </div>

    <p>This page tests your LOCAL changes to the NY English Teacher chat widget. Look for the floating button in the bottom-right corner.</p>

    <div class="card">
      <h2>What to Test</h2>
      <ul class="checklist">
        <li>Header text: "Your English Learning Assistant — Always Available"</li>
        <li>Input field has elevated pill design with shadow</li>
        <li>Gold focus ring appears when clicking input</li>
        <li>Send button has shadow depth</li>
        <li>Form wrapper has subtle top shadow separation</li>
      </ul>
    </div>

    <div class="card">
      <h2>Debug Links (Local)</h2>
      <ul class="checklist">
        <li><a href="/embed/chat" target="_blank">View Chat Directly</a></li>
        <li><a href="/api/embed/settings" target="_blank">View Settings API</a></li>
        <li><a href="/images/chatbot-icon.jpg" target="_blank">View Icon Image</a></li>
      </ul>
    </div>
  </div>

  <!-- LOCAL Chat Widget - Inline script pointing to localhost -->
  <script>
(function() {
  'use strict';

  // LOCAL DEVELOPMENT - Change this to test against production
  const CHAT_APP_URL = 'http://localhost:3000';
  const BOT_ID = 'default';

  const scriptTag = document.currentScript;
  const getAttr = (name) => scriptTag?.getAttribute(name) || scriptTag?.getAttribute('data-' + name) || scriptTag?.getAttribute(name.toLowerCase()) || scriptTag?.getAttribute('data-' + name.toLowerCase());

  const normalizeLocale = (value) => {
    if (!value) return null;
    const lower = String(value).trim().toLowerCase();
    if (lower === 'en' || lower.startsWith('en-')) return 'en';
    if (lower === 'es' || lower.startsWith('es-')) return 'es';
    return null;
  };

  const detectLocale = () => {
    const explicit = normalizeLocale(getAttr('language'));
    if (explicit) return explicit;

    try {
      const path = String(window.location.pathname || '').toLowerCase();
      if (path.includes('/es/')) return 'es';
      if (path.includes('/en/')) return 'en';
    } catch (e) {}

    try {
      const fromBrowser = normalizeLocale(navigator.language);
      if (fromBrowser) return fromBrowser;
    } catch (e) {}

    return 'en';
  };

  const language = detectLocale();

  const defaultWelcomeMessage = language === 'es'
    ? '¡Hola! Haz tus preguntas aquí!'
    : 'Hey... ask questions here!';

  const defaultPlaceholder = language === 'es'
    ? 'Escribe tu mensaje...'
    : 'Type your message...';

  const config = {
    welcomeMessage: defaultWelcomeMessage,
    showWelcomeMessage: false,
    buttonColor: '#4f46e5',
    buttonSize: 1,
    position: 'bottom-right',
    openDelay: 5000,
    autoOpen: false,
    language,
    placeholder: defaultPlaceholder,
    botIcon: '/images/chatbot-icon.jpg',
  };

  const iframeId = 'nyenglish-chat-iframe';
  const buttonId = 'nyenglish-chat-button';
  let isOpen = false;

  const fadeIn = (el, delay = 0) => {
    if (!el) return;
    const displayType = el.id === buttonId ? 'flex' : 'block';
    el.style.display = displayType;
    requestAnimationFrame(() => {
      setTimeout(() => {
        el.style.opacity = '1';
        el.style.transform = 'translateY(0) scale(1)';
      }, delay);
    });
  };

  const fadeOut = (el) => {
    if (!el) return;
    el.style.opacity = '0';
    el.style.transform = 'translateY(10px) scale(0.95)';
    setTimeout(() => { el.style.display = 'none'; }, 300);
  };

  const slideIn = (el, delay = 0) => {
    if (!el) return;
    el.style.display = 'block';
    requestAnimationFrame(() => {
      setTimeout(() => {
        el.style.opacity = '1';
        el.style.transform = 'translateX(0) translateY(0)';
      }, delay);
    });
  };

  window.addEventListener('message', (event) => {
    if (event.origin !== CHAT_APP_URL) return;

    const iframe = document.getElementById(iframeId);
    const button = document.getElementById(buttonId);

    if (event.data === 'close-chat' || event.data === 'minimize-chat') {
      if (iframe) { fadeOut(iframe); isOpen = false; }
      if (button) fadeIn(button);
    }
  });

  const openChat = () => {
    const iframe = document.getElementById(iframeId);
    const button = document.getElementById(buttonId);

    if (iframe) {
      slideIn(iframe);
      isOpen = true;
    }
    const mq = window.matchMedia('(max-width: 475px)');
    if (mq.matches && button) fadeOut(button);
  };

  const toggleChat = () => {
    if (isOpen) {
      const iframe = document.getElementById(iframeId);
      const button = document.getElementById(buttonId);
      if (iframe) { fadeOut(iframe); isOpen = false; }
      if (button) fadeIn(button);
    } else {
      openChat();
    }
  };

  const init = () => {
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideInRight {
        from { transform: translateX(100px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);

    const iframe = document.createElement('iframe');
    iframe.id = iframeId;
    iframe.title = 'Help chat';
    iframe.src = CHAT_APP_URL + '/embed/chat?lang=' + encodeURIComponent(config.language) + '&placeholder=' + encodeURIComponent(config.placeholder);
    iframe.style.cssText = 'display:none;opacity:0;position:fixed;border:none;z-index:2147483647;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1),0 10px 10px -5px rgba(0,0,0,0.04);transition:opacity 300ms cubic-bezier(0.4,0,0.2,1),transform 300ms cubic-bezier(0.4,0,0.2,1);transform:translateX(20px) translateY(10px) scale(0.95);';

    const mq = window.matchMedia('(max-width: 475px)');
    if (mq.matches) {
      iframe.style.cssText += 'width:100vw;height:100vh;bottom:0;right:0;left:0;border-radius:0;';
    } else {
      iframe.style.cssText += 'width:420px;max-width:calc(100vw - 40px);height:650px;max-height:calc(100vh - 100px);border-radius:16px;bottom:90px;right:20px;';
    }
    document.body.appendChild(iframe);

    const button = document.createElement('button');
    button.id = buttonId;
    button.setAttribute('aria-label', 'Open help chat');
    const iconUrl = CHAT_APP_URL + config.botIcon;
    button.innerHTML = '<img src="' + iconUrl + '" alt="Chat" style="width:100%;height:100%;object-fit:cover;" />';
    button.style.cssText = 'display:flex;align-items:center;justify-content:center;opacity:0;position:fixed;z-index:2147483647;width:64px;height:64px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,' + config.buttonColor + ' 0%,' + config.buttonColor + 'dd 100%);color:white;border:none;cursor:pointer;box-shadow:0 8px 16px rgba(0,0,0,0.15);transition:all 300ms cubic-bezier(0.4,0,0.2,1);transform:scale(' + config.buttonSize + ') translateY(20px);bottom:20px;right:20px;padding:0;animation:slideInRight 500ms ease-out forwards;';

    button.onmouseenter = () => {
      button.style.transform = 'scale(' + (config.buttonSize * 1.15) + ') translateY(-2px)';
    };
    button.onmouseleave = () => {
      button.style.transform = 'scale(' + config.buttonSize + ') translateY(0)';
    };
    button.onclick = toggleChat;

    document.body.appendChild(button);
    setTimeout(() => fadeIn(button), 100);
  };

  if (document.readyState === 'complete') {
    init();
  } else {
    window.addEventListener('load', init);
  }
})();
  </script>
</body>
</html>
